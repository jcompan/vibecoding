<!-- HTML Template -->
<div class="container" ng-controller="IngresoController">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h2>Tipificador de Ingresos Bancarios</h2>
    </div>
    <div class="card-body">
      <div class="form-group">
        <label for="conceptoIngreso">Concepto del Ingreso:</label>
        <input type="text" class="form-control" id="conceptoIngreso" ng-model="concepto" placeholder="Introduce el concepto de tu ingreso bancario">
      </div>
      
      <button class="btn btn-primary mt-3" ng-click="verificarTipo()" ng-disabled="!concepto">
        <i class="fas fa-search"></i> Verificar Tipo
      </button>
      
      <div class="mt-4" ng-if="tipoIngreso">
        <div class="alert" ng-class="{'alert-success': !editandoTipo, 'alert-warning': editandoTipo}">
          <div ng-if="!editandoTipo">
            <h4 class="alert-heading">Tipo de Ingreso: <span class="badge bg-info">{{tipoIngreso}}</span></h4>
            <p>Si este tipo no es correcto, puedes corregirlo:</p>
            <button class="btn btn-outline-secondary" ng-click="habilitarEdicion()">
              <i class="fas fa-edit"></i> Corregir Tipo
            </button>
          </div>
          
          <div ng-if="editandoTipo">
            <h4 class="alert-heading">Corregir Tipo de Ingreso:</h4>
            <div class="input-group mb-3">
              <input type="text" class="form-control" ng-model="tipoCorregido" placeholder="Introduce el tipo correcto">
              <button class="btn btn-success" type="button" ng-click="corregirTipo()">
                <i class="fas fa-check"></i> Confirmar
              </button>
              <button class="btn btn-outline-danger" type="button" ng-click="cancelarEdicion()">
                <i class="fas fa-times"></i> Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="mt-3" ng-if="historial.length > 0">
        <h4>Historial de Consultas</h4>
        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Concepto</th>
                <th>Tipo Detectado</th>
                <th>Tipo Corregido</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="item in historial">
                <td>{{item.concepto}}</td>
                <td>{{item.tipoDetectado}}</td>
                <td>{{item.tipoCorregido || '-'}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AngularJS Script -->
<script>
var app = angular.module('TipificadorApp', []);

app.controller('IngresoController', function($scope, $http) {
  // Variables
  $scope.concepto = '';
  $scope.tipoIngreso = null;
  $scope.editandoTipo = false;
  $scope.tipoCorregido = '';
  $scope.historial = [];
  
  // URL del API REST (a modificar según tu entorno)
  var apiUrl = 'https://api.example.com/tipificador';
  
  // Función para verificar el tipo de ingreso
  $scope.verificarTipo = function() {
    if (!$scope.concepto) return;
    
    // Mostrar indicador de carga
    $scope.cargando = true;
    
    // Llamada al API REST
    $http.post(apiUrl + '/verificar', {
      concepto: $scope.concepto
    }).then(function(response) {
      // Éxito en la llamada
      $scope.tipoIngreso = response.data.tipo;
      $scope.cargando = false;
      
      // Agregar al historial
      $scope.historial.unshift({
        concepto: $scope.concepto,
        tipoDetectado: $scope.tipoIngreso,
        tipoCorregido: null
      });
      
    }, function(error) {
      // Error en la llamada
      console.error('Error al verificar el tipo:', error);
      $scope.cargando = false;
      alert('Ocurrió un error al conectar con el servicio. Por favor, inténtalo de nuevo.');
    });
  };
  
  // Habilitar edición del tipo
  $scope.habilitarEdicion = function() {
    $scope.editandoTipo = true;
    $scope.tipoCorregido = $scope.tipoIngreso;
  };
  
  // Cancelar edición
  $scope.cancelarEdicion = function() {
    $scope.editandoTipo = false;
    $scope.tipoCorregido = '';
  };
  
  // Corregir tipo de ingreso
  $scope.corregirTipo = function() {
    if (!$scope.tipoCorregido) return;
    
    $http.post(apiUrl + '/corregir', {
      concepto: $scope.concepto,
      tipoOriginal: $scope.tipoIngreso,
      tipoCorregido: $scope.tipoCorregido
    }).then(function(response) {
      // Actualizar tipo y estado
      $scope.tipoIngreso = $scope.tipoCorregido;
      $scope.editandoTipo = false;
      
      // Actualizar historial
      $scope.historial[0].tipoCorregido = $scope.tipoCorregido;
      
      // Mostrar mensaje de éxito
      alert('¡Tipo de ingreso corregido correctamente!');
      
    }, function(error) {
      console.error('Error al corregir el tipo:', error);
      alert('Ocurrió un error al corregir el tipo. Por favor, inténtalo de nuevo.');
    });
  };
});
</script>

<!-- CSS Adicional -->
<style>
.container {
  max-width: 800px;
  margin-top: 30px;
}

.card {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  border-radius: 8px;
}

.card-header {
  border-radius: 8px 8px 0 0;
}

.badge {
  font-size: 1em;
  padding: 8px 12px;
}

.table-responsive {
  max-height: 300px;
  overflow-y: auto;
}
</style>
